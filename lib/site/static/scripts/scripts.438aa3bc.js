"use strict";var MODULES=["ui.router","ngCookies","utils","sql","stats","common","overview","feed","console","tables","cluster","tableinfo","shardinfo","nodeinfo","checks","udc","translation","datatypechecks","nvd3","pascalprecht.translate","oc.lazyLoad"],DEFAULT_PLUGINS=[],ENTERPRISE_PLUGINS=[],ROUTING={"/":{name:"overview",url:"/",templateUrl:"static/views/overview.html"},"/console":{name:"console",url:"/console",templateUrl:"static/views/console.html"},"/tables":{name:"tables",url:"/tables",template:"<tables>"},"/tables/:table_schema/:table_name":{name:"tables.table",url:"/:table_schema/:table_name",template:"<table-detail>"},"/nodes":{name:"nodes",url:"/nodes",template:"<cluster>"},"/nodes/:node_id":{name:"nodes.node",url:"/:node_id",template:"<node-detail>"},"/401":{name:"unauthorized",url:"/401",templateUrl:"static/views/401.html"}},app=angular.module("crate",MODULES),head=document.getElementsByTagName("head")[0],loadScript=function(url){var result=$.Deferred(),script=document.createElement("script");return script.async="async",script.type="text/javascript",script.src=url,script.onload=function(){result.resolve()},script.onerror=function(){result.reject()},head.appendChild(script),result.promise()},loadStylesheet=function(url){var result=$.Deferred(),link=document.createElement("link");return link.async="async",link.type="text/css",link.rel="stylesheet",link.href=url,link.onload=function(){result.resolve()},link.onerror=function(){result.reject()},head.appendChild(link),result.promise()};$.get("static/conf/plugins.json",function(plugins){ENTERPRISE_PLUGINS=plugins.filter(function(p){return p.enterprise}).map(function(el){return{name:el.name,files:[el.uri],routing:el.routing,stylesheet:el.stylesheet}}),DEFAULT_PLUGINS=plugins.filter(function(p){return!p.enterprise});for(var loadApp=function(){app=angular.module("crate",MODULES),app.config(["SQLQueryProvider","queryResultToObjectsProvider","$ocLazyLoadProvider","$stateProvider","SettingsProvider",function(SQLQueryProvider,queryResultToObjectsProvider,$ocLazyLoadProvider,$stateProvider,SettingsProvider){var stmt="SELECT settings['license']['enterprise'] as enterprise, settings['license']['ident'] as ident FROM sys.cluster";SettingsProvider.$get().enterprise===!0&&loadStylesheet("static/styles/main-enterprise.806ee28c.css"),SQLQueryProvider.$get().execute(stmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjectsProvider.$get()(query,["enterprise","ident"]);if(SettingsProvider.setEnterprise(result[0].enterprise),SettingsProvider.setIdent(result[0].ident),result[0].enterprise){loadStylesheet("static/styles/main-enterprise.806ee28c.css"),$ocLazyLoadProvider.config({modules:ENTERPRISE_PLUGINS,events:!0}),$ocLazyLoadProvider.$get().load(ENTERPRISE_PLUGINS);for(var i=0;i<ENTERPRISE_PLUGINS.length;i++){loadStylesheet(ENTERPRISE_PLUGINS[i].stylesheet);var routing=ENTERPRISE_PLUGINS[i].routing;if(routing)for(var pattern in routing)$stateProvider.state(routing[pattern])}console.info("Loaded Enterprise Plugins:",ENTERPRISE_PLUGINS.map(function(o){return o.name}))}}).error(function(){SettingsProvider.setEnterprise(!1),console.info("Failed to load Enterprise settings")})}]),app.config(["$stateProvider","$httpProvider","$urlMatcherFactoryProvider","$urlRouterProvider",function($stateProvider,$httpProvider,$urlMatcherFactoryProvider,$urlRouterProvider){$urlMatcherFactoryProvider.strictMode(!1),$httpProvider.defaults.useXDomain=!0;var pattern;for(pattern in ROUTING)$stateProvider.state(ROUTING[pattern]);for(var i=0;i<DEFAULT_PLUGINS.length;i++){var routing=DEFAULT_PLUGINS[i].routing;if(routing)for(pattern in routing)$stateProvider.state(routing[pattern])}$urlRouterProvider.otherwise("/")}]),app.config(["$translateProvider","$translatePartialLoaderProvider",function($translateProvider,$translatePartialLoaderProvider){$translatePartialLoaderProvider.addPart("."),$translateProvider.useLoader("$translatePartialLoader",{urlTemplate:"{part}/static/i18n/{lang}.json"}).registerAvailableLanguageKeys(["en","de","es"],{"en_*":"en","de_*":"de","es_*":"es","*":"en"}).determinePreferredLanguage().fallbackLanguage("en").useSanitizeValueStrategy(null),$translateProvider.useCookieStorage()}]),app.run(function($rootScope,$translate){$rootScope.$on("$translatePartialLoaderStructureChanged",function(){$translate.refresh()})}),app.run(function($rootScope){$rootScope.$on("showSideNav",function(){$rootScope.showSideNav=!0,$rootScope.showTableList=!0,$rootScope.showNodeList=!0,$rootScope.showUserList=!0}),$rootScope.$on("hideSideNav",function(){$rootScope.showSideNav=!1,$rootScope.showTableList=!1,$rootScope.showNodeList=!1,$rootScope.showUserList=!1})}),angular.element(document).ready(function(){angular.bootstrap(document,["crate"])})},promises=[],i=0;i<DEFAULT_PLUGINS.length;i++)promises.push(loadScript(DEFAULT_PLUGINS[i].uri)),DEFAULT_PLUGINS[i].stylesheet&&promises.push(loadStylesheet(DEFAULT_PLUGINS[i].stylesheet));$.when.apply($,promises).then(function(){console.info("Loaded Modules:",MODULES),console.info("Default Plugins:",DEFAULT_PLUGINS.map(function(el){return el.name})),MODULES=MODULES.concat(DEFAULT_PLUGINS.map(function(el){return el.name})),loadApp()},function(){console.info("Loaded Modules:",MODULES),console.warn("Plugins could not be loaded. Please check your config file: plugins.json"),loadApp()})}),angular.module("utils",[]).service("parseIsoDatetime",function(){return function(dtstr){var dt=dtstr.split(/[: T+-]/).map(parseFloat);return new Date(dt[0],dt[1]-1,dt[2],dt[3]||0,dt[4]||0,dt[5]||0,0)}}),angular.module("sql",[]).factory("queryResultToObjects",function(){var toObject=function(headers,row){var obj={};if(headers.length==row.length)for(var i=0;i<headers.length;i++)obj[headers[i]]=row[i];return obj};return function(sqlQuery,headers){return sqlQuery.rows.map(function(obj){return toObject(headers,obj)})}}).factory("baseURI",function(){var baseURI={};return baseURI.getWindowLocation=function(){return window.location},baseURI.getURI=function(path){var basePath,loc=baseURI.getWindowLocation(),uriParam=loc.search.match(/([\?|&])base_uri=([^&]+)/);return basePath=uriParam?uriParam[2]:loc.protocol+"//"+loc.host+loc.pathname,basePath.replace(/\/+$/,"")+path},baseURI}).factory("SQLQuery",function($http,$q,$log,baseURI,$location,$state){function SQLQuery(stmt,response,error){this.stmt=stmt,this.rows=[],this.cols=[],this.col_types=[],this.rowCount=0,this.duration=0,this.error=error,this.failed=!1,!this.error&&response?(this.rows=response.rows,this.cols=response.cols,this.col_types=void 0===response.col_types?[]:response.col_types,this.rowCount=response.rowcount,this.duration=response.duration):this.failed=!0}return SQLQuery.prototype.status=function(){var status_string="",stmt_parts=this.stmt.split(" "),cmd=stmt_parts[0].toUpperCase();if(cmd in{CREATE:"",DROP:""}&&(cmd=cmd+" "+stmt_parts[1].toUpperCase()),this.failed===!1){var text_row=1===this.rowCount?" row":" rows";status_string="SELECT"===cmd?cmd+" OK, "+this.rowCount+text_row+" in set ("+(this.duration/1e3).toFixed(3)+" sec)":cmd+" OK, "+this.rowCount+text_row+" affected ("+(this.duration/1e3).toFixed(3)+" sec)",$log.info("Query status: "+status_string)}else status_string=cmd+" ERROR ("+(this.duration/1e3).toFixed(3)+" sec)",$log.warn("Query status: "+status_string);return status_string},SQLQuery.execute=function(stmt,args,errorTrace,getTypes,isConsole,cache){var data={stmt:stmt};$.isEmptyObject(args)||(data.args=args);var canceler=$q.defer(),deferred=$q.defer(),promise=deferred.promise;promise.success=function(fn){return promise.then(function(sqlQuery){fn(sqlQuery)}),promise},promise.error=function(fn){return promise.then(null,function(sqlQuery){fn(sqlQuery)}),promise},promise.cancel=function(){canceler.reject()};var request={url:baseURI.getURI("/_sql"+(getTypes?"?types":"")),method:"POST",data:data,cache:cache,config:{timeout:canceler.promise}};return errorTrace===!0&&(request.params={error_trace:errorTrace}),$http(request).success(function(data){deferred.resolve(new SQLQuery(stmt,data,null))}).error(function(data,status){var error=null;status>=400&&data.error?(error=new Error(data.error.message),error.error_trace=data.error_trace,error.status=data.error.code,4011!==data.error.code||isConsole||$state.go("unauthorized")):status>=400?(error=new Error(data),error.status=status):0===status&&(error=new Error("Connection refused"),error.status=status),deferred.reject(new SQLQuery(stmt,data,error))}),promise},SQLQuery}),angular.module("health",[]).factory("Health",function(){var map={},Health=function Health(level){this.set=function(level){this.level=isNaN(level)?Health.UNKNOWN:level,this.name=Health.NAMES[this.level]||"--"},this.toString=function(){return this.name},this.set(level)};return Health.NAMES=["good","warning","critical"],Health.NAMES.map(function(obj,idx){map[obj]=idx}),Health.UNKNOWN=-1,Health.GOOD=0,Health.WARNING=1,Health.CRITICAL=2,Health.fromString=function(name){return new Health(map[name])},Health}),angular.module("stats",["sql","health","tableinfo","nodeinfo","events"]).factory("ClusterState",function($http,$interval,$timeout,$log,$q,$rootScope,baseURI,SQLQuery,queryResultToObjects,TableList,Health,ShardInfo,NodeInfo,ClusterEventsHandler){var reachabilityInterval,ClusterStateInterval,refreshClusterState,checkReachability,setReachability,data={online:!0,tables:[],shards:[],partitions:[],cluster:[],name:"--",status:"--",load:["-.-","-.-","-.-"],loadHistory:[[],[],[]],version:null},diskIoHistory={},refreshInterval=5e3,historyLength=60;setReachability=function(online){data.online&&!online?(data.online=!1,$log.warn("Cluster is offline."),$interval.cancel(ClusterStateInterval),data.status="--",data.tables=[],data.cluster=[],data.name="--",data.load=["-.-","-.-","-.-"],data.loadHistory=[[],[],[]],data.version=null):!data.online&&online&&(data.online=!0,$log.info("Cluster is online."),ClusterStateInterval=$interval(refreshClusterState,refreshInterval),refreshClusterState())},checkReachability=function(){$http.get(baseURI.getURI("/"),{headers:{Accept:"application/json"}}).success(function(response){if("object"==typeof response){var version=response.version;data.version={number:version.number,hash:version.build_hash,snapshot:version.build_snapshot},setReachability(!0)}else data.version=null,setReachability(!1)}).error(function(){setReachability(!1)})};var addToLoadHistory=function(load){var lh=data.loadHistory;if(load.length==lh.length)for(var i=0;i<load.length;i++)lh[i].push(load[i]),lh[i]=lh[i].splice(-historyLength,historyLength)},onErrorResponse=function(query){if(query&&query.error){var status=query.error.status;setReachability(!(0===status||404===status))}},prepareLoadInfo=function(nodeInfo){for(var numNodes=nodeInfo.length,load=[0,0,0],i=0;i<numNodes;i++){var nodeLoad=nodeInfo[i].load;nodeLoad&&(load[0]+=nodeLoad[1]/numNodes,load[1]+=nodeLoad[5]/numNodes,load[2]+=nodeLoad[15]/numNodes)}return addToLoadHistory(load),load},prepareIoStats=function(nodeInfo){for(var numNodes=nodeInfo.length,empty_iostats={rps:-1,wps:-1,rbps:-1,wbps:-1},i=0;i<numNodes;i++){var node=nodeInfo[i],currentValue={timestamp:node.timestamp};if(node.fs&&(currentValue.data=node.fs.total),diskIoHistory[node.id]&&currentValue.data){var lastValue=diskIoHistory[node.id],timeDelta=(currentValue.timestamp-lastValue.timestamp)/1e3;if(lastValue.data){var readsDelta=currentValue.data.reads-lastValue.data.reads,writesDelta=currentValue.data.writes-lastValue.data.writes,readBytesDelta=currentValue.data.bytes_read-lastValue.data.bytes_read,writtenBytesDelta=currentValue.data.bytes_written-lastValue.data.bytes_written;node.iostats={rps:currentValue.data.reads>0?readsDelta/timeDelta:-1,wps:currentValue.data.writes>0?writesDelta/timeDelta:-1,rbps:currentValue.data.bytes_read>0?readBytesDelta/timeDelta:-1,wbps:currentValue.data.bytes_written>0?writtenBytesDelta/timeDelta:-1}}else node.iostats=empty_iostats}else node.iostats=empty_iostats;diskIoHistory[node.id]=currentValue}return nodeInfo};return refreshClusterState=function(){data.online&&$q.all([ShardInfo.executeTableStmt(),ShardInfo.executeShardStmt(),ShardInfo.executePartStmt(),ShardInfo.executeRecoveryStmt(),NodeInfo.executeClusterQuery(),NodeInfo.executeNodeQuery()]).then(function(values){data.tables=values[0],data.shards=values[1],data.partitions=values[2],data.recovery=values[3];var result={tables:data.tables,shards:data.shards,partitions:data.partitions,recovery:data.recovery};ShardInfo.deferred.resolve(result);var nodeinfo=values[4];data.name=nodeinfo[0].name,data.master_node=nodeinfo[0].master_node;var nodeinfoResult={name:data.name,master_node:data.master_node,nodes:data.cluster.length};NodeInfo.deferred.resolve(nodeinfoResult);var clusterinfo=values[5];data.load=prepareLoadInfo(clusterinfo),data.cluster=prepareIoStats(clusterinfo);var tableinfo=TableList.execute(data.tables,data.shards,data.partitions,data.recovery);if(tableinfo.success){var h=tableinfo.data.tables.reduce(function(memo,obj){var health=Health.fromString(obj.health);return Math.max(health.level,memo)},0);data.status=new Health(h).name,data.tables=tableinfo.data.tables}ClusterEventsHandler.trigger("STATE_REFRESHED")}).catch(function(query){onErrorResponse(query),ShardInfo.deferred.reject({}),data.status="--",data.tables=[],ClusterEventsHandler.trigger("STATE_REFRESHED")})},checkReachability(),reachabilityInterval=$interval(checkReachability,refreshInterval),refreshClusterState(),ClusterStateInterval=$interval(refreshClusterState,refreshInterval),{data:data,HISTORY_LENGTH:historyLength,refresh:refreshClusterState}}),angular.module("tableinfo",["sql"]).factory("TableInfo",function(){var ACTIVE_SHARDS=["STARTED","RELOCATING"],isActiveShard=function(shard){return ACTIVE_SHARDS.indexOf(shard.routing_state)>-1};return function(arg1,arg2,arg3,arg4){var shards=arg1?angular.copy(arg1):[],partitionedBy=arg3?angular.copy(arg3):[],partitioned=partitionedBy.length>0,numShardsConfigured=arg2||0,recovery=arg4||[],primaryShards=function(){return shards.filter(function(shard){return shard.primary})}(),numPrimaryShards=function(){return primaryShards.reduce(function(memo,shard){return memo+shard.count},0)}(),startedShards=function(){return shards.filter(function(shard){return isActiveShard(shard)})}(),numStartedShards=function(){return startedShards.reduce(function(memo,shard){return memo+shard.count},0)}(),numActivePrimaryShards=function(){return shards.filter(function(shard){return isActiveShard(shard)&&shard.primary===!0}).reduce(function(memo,shard){return memo+shard.count},0)}(),shardSize=function(){return primaryShards.reduce(function(memo,shard){return memo+shard.size},0)}(),numRecords=function(){return primaryShards.reduce(function(memo,shard){return memo+shard.sum_docs},0)}(),numMissingPrimaryShards=function(){return partitioned&&0===numStartedShards?0:Math.max(0,numShardsConfigured-numActivePrimaryShards)}(),numUnassignedShards=function(){return shards.filter(function(shard){return"UNASSIGNED"==shard.routing_state}).reduce(function(memo,shard){return memo+shard.count},0)}(),numReplicatingShards=function(){return shards.filter(function(shard){return"INITIALIZING"==shard.routing_state&&null===shard.relocating_node}).reduce(function(memo,shard){return memo+shard.count},0)}(),numUnderreplicatedShards=function(){return Math.max(0,numUnassignedShards+numReplicatingShards-numMissingPrimaryShards)}(),avgDocsPerPrimaryShard=function(){return primaryShards.reduce(function(memo,shard,idx,arr){return memo+shard.avg_docs/arr.length},0)}(),numUnderreplicatedRecords=function(){return Math.ceil(avgDocsPerPrimaryShard*numUnassignedShards)}(),numRecordsWithReplicas=function(){var numShards=shards.reduce(function(memo,shard){return memo+shard.count},0);return Math.ceil(avgDocsPerPrimaryShard*numShards)}(),numUnavailableRecords=function(){var avgDocsPerStartedShard=startedShards.reduce(function(memo,shard,idx,arr){return memo+shard.avg_docs/arr.length},0);return Math.ceil(avgDocsPerStartedShard*numMissingPrimaryShards)}(),health=function(){if(partitioned){if(0===numStartedShards&&0===numMissingPrimaryShards&&0===numUnassignedShards&&0===numUnderreplicatedShards)return"good";if(0===numPrimaryShards||numMissingPrimaryShards>0)return"critical";if(numUnassignedShards>0||numUnderreplicatedShards>0)return"warning"}else{if(0===numPrimaryShards||numMissingPrimaryShards>0)return"critical";if(numUnassignedShards>0||numUnderreplicatedShards>0)return"warning"}return"good"}(),recovery_percent=0===shards.length||0===recovery.length?100:function(){var done=recovery.filter(function(data){return data.recovery_stage&&"DONE"===data.recovery_stage}).reduce(function(memo,data){return[memo[0]+100*data.count,memo[1]+data.count]},[0,0]),progress=recovery.filter(function(data){return data.recovery_stage&&"DONE"!==data.recovery_stage}).reduce(function(memo,data){return[memo[0]+data.recovery_percent*data.count,memo[1]+data.count]},[0,0]),unassigned=recovery.filter(function(data){return null===data.recovery_stage}).reduce(function(memo,data){return[0,memo[1]+data.count]},[0,0]),percent=(done[0]+progress[0]+unassigned[0])/(done[1]+progress[1]+unassigned[1]);return percent}();this.asObject=function(){return{shards_configured:numShardsConfigured,health:health,shards_started:numStartedShards,shards_missing:numMissingPrimaryShards,shards_underreplicated:numUnderreplicatedShards,records_total:numRecords,records_total_with_replicas:numRecordsWithReplicas,records_unavailable:numUnavailableRecords,records_underreplicated:numUnderreplicatedRecords,size:shardSize,partitioned:partitioned,partitioned_by:partitionedBy,recovery_percent:recovery_percent}}}}).factory("TableList",function(TableInfo,SQLQuery,roundWithUnitFilter){var fetch,data={tables:[]},healthPriorityMap={good:2,warning:1,critical:0,"--":0},colorMapLabel={good:"label-success",warning:"label-warning",critical:"label-danger","--":""},colorMapPanel={good:"cr-panel--success",warning:"cr-panel--warning",critical:"cr-panel--danger","--":"cr--panel-default"},sortByHealth=function(a,b){return healthPriorityMap[a.health]<healthPriorityMap[b.health]?-1:healthPriorityMap[a.health]>healthPriorityMap[b.health]?1:a.name<b.name?-1:a.name>b.name?1:0},tableFilter=function(table){return function(item){return item.table_name===table.name&&item.schema_name==table.table_schema}},update=function(success,tables,shards,partitions,recovery){var _tables=tables||[],_shards=shards||[],_partitions=partitions||[],_recovery=recovery||[];if(success&&_tables.length){for(var i=0;i<_tables.length;i++){var table=_tables[i],filterBySchemaNameTableName=tableFilter(table),shardsForTable=_shards.filter(filterBySchemaNameTableName),partitionsForTable=_partitions.filter(filterBySchemaNameTableName),recoveryForTable=_recovery.filter(filterBySchemaNameTableName);table.partitioned_by&&1===partitionsForTable.length&&(table.shards_configured=partitionsForTable[0].num_shards);var tableInfo=new TableInfo(shardsForTable,table.shards_configured,table.partitioned_by,recoveryForTable),info=tableInfo.asObject();$.extend(table,info),table.health_label_class=colorMapLabel[table.health],table.health_panel_class=colorMapPanel[table.health],table.type_display_name="blob"==table.table_schema?"TABLE.BLOBS":"TABLE.RECORDS";var summary=table.shards_configured+" Shards";summary+=" / "+table.replicas_configured+" Replicas",table.records_unavailable?summary=roundWithUnitFilter(table.records_unavailable,1)+" Unavailable Records / "+summary:table.shards_underreplicated&&(summary=table.shards_underreplicated+" Underreplicated Shards / "+summary),table.records_underreplicated&&(summary=table.records_underreplicated+" Underreplicated Records / "+summary),table.summary=summary}data.tables=_tables.sort(sortByHealth)}else data.tables=[];return{success:success,data:data}};return fetch=function(tables,shards,partitions,recovery){return tables&&shards&&partitions&&recovery?update(!0,tables,shards,partitions,recovery):jQuery.isEmptyObject([tables,shards,partitions,recovery])?void 0:tables&&shards&&recovery?update(!0,tables,shards,null,recovery):tables?update(!0,tables):update(!1)},fetch(),{data:data,execute:fetch}}),angular.module("shardinfo",["sql"]).factory("ShardInfo",function(SQLQuery,queryResultToObjects,$q){var shardInfo={deferred:$q.defer()},tableStmt="SELECT table_name, table_schema, format('%s.%s', table_schema, table_name) AS fqn, number_of_shards, number_of_replicas, partitioned_by FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'sys', 'pg_catalog')",shardStmt="SELECT table_name, schema_name, format('%s.%s', schema_name, table_name) AS fqn, _node['id'] AS node_id, state, routing_state, relocating_node, count(*), \"primary\", sum(num_docs), avg(num_docs), sum(size) FROM sys.shards GROUP BY table_name, schema_name, fqn, node_id, state, routing_state, relocating_node, \"primary\"",partStmt="SELECT table_name, schema_name, format('%s.%s', schema_name, table_name) AS fqn, SUM(number_of_shards) AS num_shards FROM information_schema.table_partitions WHERE closed = false GROUP BY table_name, schema_name, fqn",recoveryStmt="SELECT table_name, schema_name, recovery['stage'] AS recovery_stage, AVG(recovery['size']['percent']), COUNT(*) AS count FROM sys.shards GROUP BY table_name, schema_name, recovery_stage";return shardInfo.executeTableStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(tableStmt,{},!1,!1,!1,!1).success(function(tableQuery){var result=queryResultToObjects(tableQuery,["name","table_schema","fqn","shards_configured","replicas_configured","partitioned_by"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo.executeShardStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(shardStmt,{},!1,!1,!1,!1).success(function(shardQuery){var result=queryResultToObjects(shardQuery,["table_name","schema_name","fqn","node_id","state","routing_state","relocating_node","count","primary","sum_docs","avg_docs","size"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo.executePartStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(partStmt,{},!1,!1,!1,!1).success(function(partQuery){var result=queryResultToObjects(partQuery,["table_name","schema_name","fqn","num_shards"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo.executeRecoveryStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(recoveryStmt,{},!1,!1,!1,!1).success(function(recoveryQuery){var result=queryResultToObjects(recoveryQuery,["table_name","schema_name","recovery_stage","recovery_percent","count"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo}),angular.module("nodeinfo",["sql"]).factory("NodeHealth",function(){var state=function(val){return val>98?2:val>90?1:0};return function(node){var fs_used_percent=node.fs?node.fs.used_percent:0,heap_used_percent=node.heap?node.heap.used_percent:0;0===fs_used_percent&&0===heap_used_percent?this.status="unreacheable":(this.value=state(Math.max(fs_used_percent,heap_used_percent)),this.status=["good","warning","critical"][this.value])}}).factory("NodeInfo",function(SQLQuery,queryResultToObjects,$q){var nodeInfo={deferred:$q.defer()},nodeQuery="SELECT id, name, hostname, rest_url, port, heap, fs, os['cpu'], load, version, os['probe_timestamp'], process['cpu'], os_info['available_processors'] FROM sys.nodes ORDER BY id",nodeCols=["id","name","hostname","rest_url","port","heap","fs","cpu","load","version","timestamp","proc_cpu","num_cores"];nodeInfo.executeNodeQuery=function(){var d=$q.defer();return SQLQuery.execute(nodeQuery,{},!1,!1,!1,!1).success(function(sqlQuery){var response=queryResultToObjects(sqlQuery,nodeCols);d.resolve(response)}).error(function(){d.reject()}),d.promise};var clusterQuery="select name, master_node from sys.cluster",clusterCols=["name","master_node"];return nodeInfo.executeClusterQuery=function(){var d=$q.defer();return SQLQuery.execute(clusterQuery,{},!1,!1,!1,!1).success(function(sqlQuery){d.resolve(queryResultToObjects(sqlQuery,clusterCols))}).error(function(){d.reject()}),d.promise},nodeInfo}).provider("NodeListInfo",function(){var sortInfo={sort:{col:["health_value","name"],desc:!1},sortBy:function(col){0===this.sort.col.indexOf(col)?this.sort.desc=!this.sort.desc:(this.sort.col=this.sort.col.reverse(),this.sort.desc=!1)},sortClass:function(col){return 0===this.sort.col.indexOf(col)?this.sort.desc?"fa fa-caret-down":"fa fa-caret-up":""}};this.$get=function(){return sortInfo}}).factory("prepareNodeList",function(NodeHealth){var LABEL_COLOR_MAP={good:"label-success",warning:"label-warning",critical:"label-danger",unreacheable:"label-unreacheable","--":""};return function(cluster,master_node){for(var nodeList=[],i=0;i<cluster.length;i++){var node=angular.copy(cluster[i]);node.health=new NodeHealth(node),node.health_value=node.health.value,node.health_label_class=node.health?LABEL_COLOR_MAP[node.health.status]:LABEL_COLOR_MAP.unreacheable,node.health_panel_class=node.health?LABEL_COLOR_MAP[node.health.status]:LABEL_COLOR_MAP.unreacheable,node.heap?(node.heap.used_percent=100*node.heap.used/node.heap.max,node.heap.free_percent=100-node.heap.used_percent):(node.heap={},node.heap.used_percent=0,node.heap.free_percent=100),node.master_node=node.id===master_node,nodeList.push(node)}return nodeList}}).factory("compareByHealth",function(){return function(a,b){return a.health.value<b.health.value?-1:a.health.value>b.health.value?1:a.name<b.name?-1:a.name>b.name?1:0}}),angular.module("checks",["sql","events"]).factory("ClusterCheck",function(SQLQuery,queryResultToObjects,$q){var self={deferred:$q.defer()},stmt="SELECT id, severity, description, passed FROM sys.checks WHERE passed = FALSE ORDER BY severity DESC, id",cols=["id","severity","description","passed"];return self.execute=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(stmt,{},!1,!1,!1,!1).success(function(query){var result=queryResultToObjects(query,cols);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},self}).factory("NodeCheck",function(SQLQuery,queryResultToObjects,$q){var self={deferred:$q.defer()},stmt="SELECT c.id, c.severity, c.description, c.passed, c.node_id, n.name, c.acknowledged FROM sys.node_checks AS c, sys.nodes AS n WHERE c.node_id = n.id AND c.passed = FALSE AND acknowledged = FALSE ORDER BY c.severity DESC, n.name",cols=["id","severity","description","passed","node_id","node_name","acknowledged"];return self.execute=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(stmt,{},!1,!1,!1,!1).success(function(query){var result=queryResultToObjects(query,cols),checks={};result.map(function(check){var id=check.id;id in checks||(check.nodes=[],checks[id]=check),checks[id].nodes.push({name:check.node_name,id:check.node_id})});var array=Object.keys(checks).map(function(id){return checks[id]});deferred.resolve(array)}).error(function(){deferred.reject()}),promise},self}).factory("ChecksService",function($timeout,$q,NodeCheck,ClusterCheck,$rootScope,ClusterEventsHandler){var data={checks:{},success:!1},retryCount=0;return data.fetch=function(force){$q.all([ClusterCheck.execute(),NodeCheck.execute()]).then(function(responses){data.checks.cluster_checks=responses[0],data.checks.node_checks=responses[1],data.success=!0,retryCount=0,force!==!0&&$timeout(data.fetch,6e4),ClusterEventsHandler.trigger("CHECKS_REFRESHED")}).catch(function(){data.success=!1,retryCount++,force!==!0&&$timeout(data.fetch,500*retryCount),ClusterEventsHandler.trigger("CHECKS_REFRESHED")})},$timeout(data.fetch,5),data.refresh=function(){data.fetch(!0)},data}),angular.module("udc",[]).factory("UdcSettings",function(SQLQuery,queryResultToObjects,$q){var deferred=$q.defer(),promise=deferred.promise;promise.success=function(result){return promise.then(result,null,null),promise},promise.error=function(error){return promise.then(null,error,null),promise};var stmt="SELECT settings['udc']['enabled'] as enabled, id AS cluster_id FROM sys.cluster";return SQLQuery.execute(stmt,{},!1,!1,!1,!1).success(function(query){var result=queryResultToObjects(query,["enabled","cluster_id"]);deferred.resolve(result[0])}).error(function(){deferred.reject("Could not load udc setting")}),{SegmentIoToken:"sfTz0KpAhR0KmOH4GnoqbpLID71eaB3w",availability:promise}}).factory("Uid",function(){var Uid=function(uid){this.uid=uid};return Uid.create=function(uid){return new Uid(uid)},Uid.prototype.isValid=function(){return!!this.uid&&null!==this.uid.match(/^[a-f0-9]{32}$/)},Uid.prototype.toString=function(){return this.uid},Uid.NAME="uid",Uid}).factory("UidLoader",function($q,Uid){var cachedUid=null,loadIframe=function(uri){var ifr=document.createElement("iframe");return ifr.id="ifr"+(new Date).getTime(),ifr.style.width="0px",ifr.style.height="0px",ifr.src=uri,document.getElementsByTagName("body")[0].appendChild(ifr),ifr},DOMAIN="cdn.crate.io",PATH="/libs/crate/uid.html";return{load:function(){var deferred=$q.defer(),promise=deferred.promise;if(promise.success=function(fn){return promise.then(fn,null,null),promise},promise.error=function(fn){return promise.then(null,fn,null),promise},promise.notify=function(fn){return promise.then(null,null,fn),promise},null===cachedUid){window.addEventListener("message",function(event){if(event.origin.match(DOMAIN)){deferred.notify(event);var uid=Uid.create(event.data[Uid.NAME]);uid.isValid()?(cachedUid=uid,deferred.resolve(uid)):deferred.reject(new Error("Cookie failed to load"))}},!1);var protocol="https:"===window.location.protocol?"https:":"http:";loadIframe(protocol+"//"+DOMAIN+PATH)}else deferred.resolve(cachedUid);return promise}}}),angular.module("translation",[]).factory("Translation",function(){var TranslationService=this;return TranslationService.interpolate=function(sentence,terms){for(var term in terms){var regex=new RegExp("\\{"+term+"\\}","gi");sentence=sentence.replace(regex,terms[term])}return sentence},TranslationService}),angular.module("datatypechecks",[]).factory("ColumnTypeCheck",function(){var ColumnTypeCheck={},formattedDataTypes=[11,13,14,12];return ColumnTypeCheck.isGeopoint=function(dataType){return 13==dataType},ColumnTypeCheck.isGeoarea=function(dataType){return 14==dataType},ColumnTypeCheck.isTimestamp=function(dataType){return 11==dataType},ColumnTypeCheck.requiresJSONFormatting=function(dataType){return 12==dataType},ColumnTypeCheck.requiresArrayFormatting=function(dataType){return Array.isArray(dataType)},ColumnTypeCheck.requiresNoFormatting=function(dataType){return!(formattedDataTypes.indexOf(dataType)!=-1||Array.isArray(dataType))},ColumnTypeCheck.isSafe=function(number){return!Number.isInteger(number)||Number.isSafeInteger(number)},ColumnTypeCheck}).factory("ObjectTypeCheck",function($filter,ConsoleFormatting){var ObjectTypeCheck={};return ObjectTypeCheck.isArray=function(object){return!!object&&Array.isArray(object)},ObjectTypeCheck.isObject=function(object){return!!object&&(!this.isArray(object)&&"object"==typeof object)},ObjectTypeCheck.isValue=function(object){return!this.isArray(object)&&!this.isObject(object)},ObjectTypeCheck.getType=function(object){return typeof object},ObjectTypeCheck.getArrayBaseType=function(array,typesArray){return 1==typesArray[1]?this.getType(array[0]):ConsoleFormatting.columnTypeClass(typesArray[1])},ObjectTypeCheck}),angular.module("events",[]).service("ClusterEventsHandler",function(){var listeners={},service={};return service.register=function(event_name,controller_name,callback){listeners[event_name]||(listeners[event_name]={}),listeners[event_name][controller_name]=callback},service.trigger=function(event_name){for(var controller in listeners[event_name]){var callback=listeners[event_name][controller];callback()}},service.remove=function(event_name,controller_name){delete listeners[event_name][controller_name],listeners[event_name]==={}&&delete listeners[event_name]},service});var commons=angular.module("common",["stats","udc","events","sql"]).provider("Settings",function(){
var enterprise,ident="",user="";return enterprise=!!localStorage.getItem("crate_setting_enterprise")&&localStorage.getItem("crate_setting_enterprise"),{setEnterprise:function(value){enterprise=value;try{localStorage.setItem("crate_setting_enterprise",value)}catch(error){console.log("localStorage cannot be set in Safari private mode",error)}},setIdent:function(value){ident=value},setUser:function(value){user=value},$get:function(){return{enterprise:enterprise,ident:ident,user:user}}}}).controller("UnauthorizedCtrl",[function(){}]).controller("StatusBarController",function($scope,$rootScope,$log,$location,$translate,$sce,ClusterState,ChecksService,UidLoader,UdcSettings,Settings,Clipboard,ClusterEventsHandler,SQLQuery,queryResultToObjects){if(Settings.enterprise){var userStmt="SELECT CURRENT_USER";SQLQuery.execute(userStmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjects(query,["user"]);Settings.user=result[0].user,$scope.userName=Settings.user})}var HEALTH=["good","warning","critical","--"],LABELS=["cr-bubble--success","cr-bubble--warning","cr-bubble--danger","cr-bubble--danger"],colorMap=HEALTH.reduce(function(memo,o,idx){return memo[o]=LABELS[idx],memo},{}),DOCS_BASE_URL="https://crate.io/docs",getMajorMinorVersion=function(version){var SHORT_VERSION_RE=new RegExp(/(\d+\.\d+)\.\d+.*/);return version?version.number.match(SHORT_VERSION_RE)[1]:null},getDocsUrl=function(version){return $sce.trustAsResourceUrl(DOCS_BASE_URL+(version?"/en/"+version:"/stable")+"/")};$scope.cluster_color_label="",$scope.config_label="",$scope.goToPath=function(path){$location.path(path).search("user="+Settings.user)};var showSideNav=!1;$scope.enterprise=Settings.enterprise,$scope.licenseIdent=Settings.ident,$scope.toggleSideNav=function(){showSideNav=!showSideNav,showSideNav?$rootScope.$broadcast("showSideNav"):$rootScope.$broadcast("hideSideNav")},$scope.copy=function(text){Clipboard.copy(text)},$scope.showSettings=!1,$scope.toggleSettings=function(){$scope.showSettings=!$scope.showSettings};var updateClusterChecks=function(){if(ChecksService.success===!0){var checks=[];checks.push.apply(checks,ChecksService.checks.cluster_checks),checks.push.apply(checks,ChecksService.checks.node_checks);var severity=checks.reduce(function(memo,obj){return Math.max(memo,obj.severity)},1);$translate(["STATUSBAR.CHECK","STATUSBAR.CHECKS","STATUSBAR.FAILED"]).then(function(i18n){$scope.checks_message=$sce.trustAsHtml([checks.length,1==checks.length?i18n["STATUSBAR.CHECK"]:i18n["STATUSBAR.CHECKS"],i18n["STATUSBAR.FAILED"]].join(" ")),$scope.config_label=LABELS[Math.min(severity-1,LABELS.length-1)]})}else $translate(["STATUSBAR.CLUSTER_OFFLINE"]).then(function(i18n){$scope.checks_message=$sce.trustAsHtml(i18n["STATUSBAR.CLUSTER_OFFLINE"])}),$scope.config_label=""};ClusterEventsHandler.register("CHECKS_REFRESHED","StatusBarController",updateClusterChecks),updateClusterChecks();var updateClusterInfo=function(){var hashes=[],versions=ClusterState.data.cluster.filter(function(obj){var contains=!1;if(obj.version){var hash=obj.version.build_hash;contains=hashes.indexOf(hash)==-1,hashes.push(hash)}return contains}).map(function(obj){return obj.version.number});$scope.versions=versions,$scope.version_warning=versions.length>1,$scope.cluster_state=ClusterState.data.status,$scope.cluster_name=ClusterState.data.name,$scope.num_nodes=ClusterState.data.cluster.length,$scope.load1="-.-"==ClusterState.data.load[0]?ClusterState.data.load[0]:ClusterState.data.load[0].toFixed(2),$scope.load1=$scope.load1<0?"N/A":$scope.load1,$scope.load5="-.-"==ClusterState.data.load[1]?ClusterState.data.load[1]:ClusterState.data.load[1].toFixed(2),$scope.load5=$scope.load5<0?"N/A":$scope.load5,$scope.load15="-.-"==ClusterState.data.load[2]?ClusterState.data.load[2]:ClusterState.data.load[2].toFixed(2),$scope.load15=$scope.load15<0?"N/A":$scope.load15,$scope.version=ClusterState.data.version,$scope.major_minor_version=getMajorMinorVersion(ClusterState.data.version),$scope.docs_url=getDocsUrl($scope.major_minor_version),$scope.cluster_color_label=ClusterState.data.online?colorMap[ClusterState.data.status]:""};ClusterEventsHandler.register("STATE_REFRESHED","StatusBarController",updateClusterInfo),updateClusterInfo(),$("[rel=tooltip]").tooltip({placement:"bottom"});var verified=null;if($scope.user={uid:null},analytics){analytics.load(UdcSettings.SegmentIoToken),analytics.ready(function(){var user=analytics.user();verified={id:user.id(),traits:user.traits()}});var identify=function(userdata){null!==userdata.user.uid&&(analytics.setAnonymousId(userdata.user.uid),analytics.identify(userdata.user.uid),analytics.page(),$scope.version&&analytics.track("visited_admin",{version:$scope.version.number,cluster_id:userdata.cluster_id}))};UdcSettings.availability.success(function(data){data.enabled===!0&&UidLoader.load().success(function(uid){$scope.user.uid=uid.toString(),identify({user:$scope.user,cluster_id:data.cluster_id})}).error(function(error){console.warn(error)})})}$scope.$on("$destroy",function(){ClusterEventsHandler.remove("CHECKS_REFRESHED","StatusBarController")})}).controller("NavigationController",function($scope,$rootScope,$location,NavigationService){$scope.navBarElements=NavigationService.navBarElements,$scope.showSideNav=!1,$rootScope.$on("showSideNav",function(){$scope.showSideNav=!0}),$rootScope.$on("hideSideNav",function(){$scope.showSideNav=!1}),$scope.goToPath=function(path){$location.path(path)},$scope.isActive=function(viewLocation){return"/"==viewLocation?viewLocation===$location.path():$location.path().substr(0,viewLocation.length)==viewLocation}}).service("Clipboard",function(){var copyToClipboard=function(text_to_share){var copyElement=document.createElement("span");copyElement.appendChild(document.createTextNode(text_to_share)),copyElement.id="tempCopyToClipboard",angular.element(document.body.append(copyElement));var range=document.createRange();range.selectNode(copyElement),window.getSelection().removeAllRanges(),window.getSelection().addRange(range),document.execCommand("copy"),window.getSelection().removeAllRanges(),copyElement.remove()};return{copy:copyToClipboard}}).service("NavigationService",function(){var navBarElements=[],addNavBarElement=function(iconClass,text,urlPattern,index){"/"!=urlPattern.charAt(0)&&(urlPattern="/"+urlPattern);var pluginElement={text:text,iconSrc:iconClass,urlPattern:urlPattern,position:index};navBarElements.push(pluginElement),navBarElements.sort(function(a,b){return a.position-b.position})},updateNavBarElement=function(urlPattern,text){"/"!=urlPattern.charAt(0)&&(urlPattern="/"+urlPattern);var queryElements=navBarElements.filter(function(item){return item.urlPattern==urlPattern});0!==queryElements.length&&(queryElements[0].text=text)};return{addNavBarElement:addNavBarElement,updateNavBarElement:updateNavBarElement,navBarElements:navBarElements}}).controller("LanguageSwitchController",function($scope,$translate){$scope.showDropDown=!1,$scope.toggleDropDown=function(){$scope.showDropDown=!$scope.showDropDown},$scope.selectedLanguage="auto",$scope.changeLanguage=function(langKey){langKey="auto"===langKey?$translate.preferredLanguage():langKey,$translate.use(langKey),$scope.selectedLanguage=langKey,$scope.toggleDropDown()}}).directive("crTooltip",function(){return{restrict:"A",scope:{crTooltipPosition:"@"},link:function(scope,element){$(element[0]).tooltip({placement:scope.crTooltipPosition})}}}).directive("crCustomTooltip",function(){return{restrict:"E",scope:{pageX:"=pageX",pageY:"=pageY"},trasclude:!0,controller:function($scope){$scope.updateTootipPosition=function(){var tw=Math.max($("#cr-custom-tooltip").outerWidth(),400),th=Math.max($("#cr-custom-tooltip").outerHeight(),300),x=$scope.pageX,y=$scope.pageY,w=$(document).width(),h=$(document).height(),css={};x+tw>=w?css.left=x-tw+"px":css.left=x+"px",y+th>=h?css.top=y-th+"px":css.top=y+"px",$("#cr-custom-tooltip").css(css)};var watcherPageX=$scope.$watch("pageX",function(){$scope.updateTootipPosition()},!0),watcherPageY=$scope.$watch("pageY",function(){$scope.updateTootipPosition()},!0);$scope.$on("$destroy",function(){watcherPageY(),watcherPageX()})}}});commons.run(function(NavigationService,$translate,$filter,$rootScope){NavigationService.addNavBarElement("static/assets/icon-overview.e4111b28.svg",$filter("translate","NAVIGATION.OVERVIEW"),"/",10),NavigationService.addNavBarElement("static/assets/icon-console.33b8f8be.svg",$filter("translate","NAVIGATION.CONSOLE"),"/console",20),NavigationService.addNavBarElement("static/assets/icon-table.7602d1ff.svg",$filter("translate","NAVIGATION.TABLE"),"/tables",30),NavigationService.addNavBarElement("static/assets/icon-cluster.dd7a24b9.svg",$filter("translate","NAVIGATION.CLUSTER"),"/nodes",40),$rootScope.$on("$translateChangeSuccess",function(){$translate(["NAVIGATION.OVERVIEW","NAVIGATION.CONSOLE","NAVIGATION.TABLE","NAVIGATION.CLUSTER"]).then(function(i18n){NavigationService.updateNavBarElement("/",i18n["NAVIGATION.OVERVIEW"]),NavigationService.updateNavBarElement("/console",i18n["NAVIGATION.CONSOLE"]),NavigationService.updateNavBarElement("/tables",i18n["NAVIGATION.TABLE"]),NavigationService.updateNavBarElement("/nodes",i18n["NAVIGATION.CLUSTER"])})})}),angular.module("feed",["stats","udc","utils"]).factory("QueryStringAppender",function(){return{append:function(url,k,v){var qs=k+"="+v;return url.indexOf("?")>-1?url+"&"+qs:url+"?"+qs}}}).factory("FeedService",function($http,QueryStringAppender){return{parse:function(url){var fullUrl=QueryStringAppender.append(url,"callback","JSON_CALLBACK");return $http.jsonp(fullUrl,{cache:!1})}}}).factory("NotificationService",function(){var readItems=null,key="crate.readNotifications";return{readItems:function(){if(null===readItems){var v=localStorage.getItem(key);readItems=v?JSON.parse(v):[]}return readItems},markAsRead:function(id){var items=this.readItems();items.push(id),readItems=items,localStorage.setItem(key,JSON.stringify(items))}}}).controller("NotificationsController",function($scope,$sce,$http,$filter,$window,FeedService,QueryStringAppender,NotificationService,ClusterState,UdcSettings,UidLoader){var CRATE_IO="https://crate.io",doNotTrackUrl=function(url){return QueryStringAppender.append(url,"udc.enabled","false")};$scope.blog_url=CRATE_IO+"/blog",$scope.demo_url=CRATE_IO+"/demo",$scope.version_url=CRATE_IO+"/versions.json",$scope.menu_url=CRATE_IO+"/feed/menu.json",UdcSettings.availability.success(function(data){data.enabled!==!0&&($scope.blog_url=doNotTrackUrl($scope.blog_url),$scope.demo_url=doNotTrackUrl($scope.demo_url),$scope.version_url=doNotTrackUrl($scope.version_url),$scope.feed_url=doNotTrackUrl($scope.feed_url),$scope.menu_url=doNotTrackUrl($scope.menu_url)),$scope.numUnread=0,$scope.entries=[];var stableVersion;FeedService.parse($scope.version_url).success(function(response){response&&response.crate&&(stableVersion=response.crate)}),$scope.$watch(function(){return ClusterState.data},function(data){$scope.showUpdate=data.version&&stableVersion&&stableVersion>data.version.number,$scope.stableVersion=stableVersion,$scope.serverVersion=data.version?data.version.number:""},!0),$scope.showUpdate=!1,FeedService.parse($scope.menu_url).success(function(response){response&&response.data&&($scope.menu=response.data),UidLoader.load().success(function(uid){null!==uid&&data.enabled===!0&&$scope.menu.map(function(item){item.url=QueryStringAppender.append(item.url,"ajs_uid",uid.toString()),item.url=QueryStringAppender.append(item.url,"ajs_aid",uid.toString())})})})}),$scope.markAsRead=function(item){if("all"===item){for(var all=$scope.entries,i=0;i<all.length;i++)NotificationService.markAsRead(all[i].id);$scope.numUnread=0}else item&&(NotificationService.markAsRead(item.id),$scope.numUnread=Math.max(0,$scope.numUnread-1))},$scope.goToUrl=function(url){$window.open(url,"_blank")},$scope.menu=[{url:"https://crate.io/demo?utm_source=adminui&utm_medium=browser&utm_term=&utm_content=demolink&utm_campaign=newsfeed&ajs_event=clicked_demo_link",title:"Schedule a 1-ON-1 demo with a Crate.io engineer"}]}),angular.module("overview",["stats","checks","ngSanitize","events"]).factory("NullArray",function(){return{create:function(len){for(var res=new Array(len),i=0;i<res.length;i++)res[i]=null;return res}}}).controller("OverviewController",function($scope,$location,$log,$timeout,$interval,ClusterState,NullArray,ChecksService,SQLQuery,SeverityClass,ClusterEventsHandler){var colorMap={good:"cr-panel--success",warning:"cr-panel--warning",critical:"cr-panel--danger","--":"cr-panel--default"},chartConf=[{key:"Load 1",color:"#5bd5f5",area:!0},{key:"Load 5",color:"#5d89fe"},{key:"Load 15",color:"#44e3a6"}];$scope.severityClass=SeverityClass,$scope.options={chart:{type:"lineChart",height:350,margin:{top:20,right:2,bottom:10,left:40},showXAxis:!1,showYAxis:!0,showLegend:!1,tooltip:{enabled:!1},yAxis:{tickFormat:function(d){return d3.format(".2f")(d)},axisLabelDistance:-10,showMaxMin:!1},dispatch:{renderEnd:function(){$scope.api.update()}}}};var chartCache=[[],[],[]];$scope.available_data="--",$scope.records_unavailable="--",$scope.replicated_data="--",$scope.records_total="--",$scope.records_underreplicated="--",$scope.cluster_state="--",$scope.cluster_color_class="cr-panel--default",$scope.chart={data:[],toggleLoad:function(e,idx){$("#load-btn-"+idx).toggleClass("cr-radio-button__load__toggle--inactive"),$("#cluster-load .nv-series-"+idx).toggle()}},ClusterEventsHandler.register("CHECKS_REFRESHED","OverviewController",function(){ChecksService.success===!0?$scope.checks=ChecksService.checks:$scope.checks={node_checks:[],cluster_check:[]}}),ChecksService.success===!0?$scope.checks=ChecksService.checks:$scope.checks={node_checks:[],cluster_check:[]};var removeFromArray=function(arr,obj){arr.splice(arr.indexOf(obj),1)},removeCheck=function(check){removeFromArray($scope.checks.node_checks,check)},drawGraph=function(history){chartCache=history;var data,len=history[0].length;if(len<ClusterState.HISTORY_LENGTH){var missing=ClusterState.HISTORY_LENGTH-len;data=[NullArray.create(missing),NullArray.create(missing),NullArray.create(missing)];for(var i=0;i<data.length;i++)data[i].push.apply(data[i],history[i])}else data=history;for(var l=0;l<data.length;l++)data[l]=data[l].map(function(load){return load>=0?load:null});$scope.chart.data=data.map(function(lineData,i){var line=angular.copy(chartConf[i]);return line.values=lineData.map(function(val,j){return{x:j,y:val}}),line})};$scope.dismissCheckByNode=function(node,check){var stmt="UPDATE sys.node_checks SET acknowledged = TRUE WHERE node_id = ? AND id = ?";SQLQuery.execute(stmt,[node.id,check.id],!1,!1,!1,!1).success(function(){removeFromArray(check.nodes,node),0===check.nodes.length&&removeCheck(check)})},$scope.config={visible:!0,debounce:5},$scope.dismissCheck=function(check){var stmt="UPDATE sys.node_checks SET acknowledged = TRUE WHERE id = ?";SQLQuery.execute(stmt,[check.id],!1,!1,!1,!1).success(function(){removeCheck(check)})};var updateClusterData=function(){$scope.cluster={name:ClusterState.data.name,state:ClusterState.data.status},$scope.cluster_color_class=colorMap[ClusterState.data.status],ClusterState.data.loadHistory[0].length>0&&drawGraph(ClusterState.data.loadHistory),ClusterState.data.tables&&ClusterState.data.tables.length||($scope.available_data=100,$scope.records_unavailable=0,$scope.replicated_data=100,$scope.records_total=0,$scope.records_total_with_replicas=0,$scope.records_underreplicated=0);var tables=ClusterState.data.tables;$scope.records_underreplicated=tables.reduce(function(memo,tableInfo){return tableInfo.records_underreplicated+memo},0),$scope.records_unavailable=tables.reduce(function(memo,tableInfo){return tableInfo.records_unavailable+memo},0),$scope.records_total=tables.reduce(function(memo,tableInfo){return tableInfo.records_total+memo},0),$scope.records_total_with_replicas=tables.reduce(function(memo,tableInfo){return tableInfo.records_total_with_replicas+memo},0),$scope.records_total_with_replicas>0?($scope.replicated_data=Math.max(0,$scope.records_total_with_replicas-$scope.records_underreplicated)/$scope.records_total_with_replicas*100,$scope.available_data=Math.max(0,$scope.records_total_with_replicas-$scope.records_unavailable)/$scope.records_total_with_replicas*100):($scope.replicated_data=100,$scope.available_data=100)};ClusterEventsHandler.register("STATE_REFRESHED","OverviewController",updateClusterData),updateClusterData(),$("[rel=tooltip]").tooltip({placement:"top"}),$scope.$on("$viewContentLoaded",function(){$timeout(function(){$scope.api.refresh()},100)}),$scope.$on("$destroy",function(){$scope.api.clearElement(),ClusterEventsHandler.remove("CHECKS_REFRESHED","OverviewController"),ClusterEventsHandler.remove("STATE_REFRESHED","OverviewController")})}),angular.module("console",["sql","datatypechecks","stats"]).factory("KeywordObjectCreator",function(){return{create:function(arr){return arr.reduce(function(accumulator,currentValue){return accumulator[currentValue.toLowerCase()]=!0,accumulator},{})}}}).service("ConsoleFormatting",function(){return{queryStatusClass:function(status){return void 0===status?"":status.indexOf("OK")!==-1?"query-status--ok":status.indexOf("ERROR")!==-1?"query-status--error":""}}}).service("ConsoleState",function(){var state={},service={};return service.save=function(consoleState){state=consoleState},service.restore=function(){return state},service}).directive("console",function(SQLQuery,ColumnTypeCheck,ConsoleFormatting,ClusterState){return{restrict:"A",controller:["$scope","$translate","$location","Clipboard","$timeout",function($scope,$translate,$location,Clipboard,$timeout){function scrollTop(){var top=$(".query-result-container").position().top;$("html,body").animate({scrollTop:top},500)}function safeApply(scope,fn){if(scope&&scope.$root){var phase=scope.$root.$$phase;"$apply"==phase||"$digest"==phase?scope.$eval(fn):scope.$apply(fn)}}function getDataType(col,type){if(null===col)return"null";if(Array.isArray(type))return"array";switch(type){case 2:case 6:case 7:case 8:case 9:case 10:return"number";case 4:case 5:return"string";case 3:return"boolean";case 11:return"timestamp";case 12:return"object";case 13:return"geo_point";case 14:return"geo_shape"}}function formatData(){if($scope.formatted_rows=[],$scope.rows)for(var i=0;i<$scope.rows.length;i++)for(var row=$scope.rows[i],j=0;j<row.length;j++){var col=row[j],dataType=getDataType(col,$scope.resultHeaderTypes[j]);$scope.formatted_rows[i]||($scope.formatted_rows[i]=[]),$scope.formatted_rows[i].push({value:col,type:dataType})}$scope.paginated_formatted_rows=$scope.formatted_rows.slice($scope.startIndex,$scope.endIndex)}var self=this;$timeout(function(){$("#cr-console-query").attr("tabindex",-1).focus()},500);var inputScope=null,statement="",displayedErrorTraceHint="1"===localStorage.getItem("crate.console.displayed_error_trace_hint");$scope.showOptions=!1,self.recentQueries=[],$scope.showErrorTrace="1"===localStorage.getItem("crate.console.error_trace"),$scope.formatResults="1"===(localStorage.getItem("crate.console.format_results")||"1"),$scope.error={hide:!0,message:"",error_trace:""},$scope.info={hide:!0,message:""},$scope.pageSize=50,$scope.startIndex=0,$scope.page=1,$scope.numberOfPages=1,$scope.endIndex=$scope.startIndex+$scope.pageSize,$scope.next=function(){$scope.startIndex>=$scope.rows.length||$scope.startIndex+$scope.pageSize>=$scope.rows.length||($scope.paginated_formatted_rows=[],$scope.paginated_formatted_rows=[],$scope.startIndex=$scope.startIndex+$scope.pageSize,$scope.endIndex=$scope.endIndex+$scope.pageSize,$scope.endIndex>$scope.rows.length&&($scope.endIndex=$scope.rows.length),$scope.paginated_formatted_rows=$scope.formatted_rows.slice($scope.startIndex,$scope.endIndex),$scope.paginated_rows=$scope.rows.slice($scope.startIndex,$scope.endIndex),$scope.page+=1,scrollTop())},$scope.previous=function(){$scope.paginated_formatted_rows=[],$scope.paginated_formatted_rows=[],$scope.startIndex===$scope.rows.length?$scope.startIndex=$scope.startIndex-$scope.pageSize:($scope.startIndex=$scope.startIndex-$scope.pageSize,$scope.endIndex=$scope.endIndex-$scope.pageSize,$scope.startIndex<0&&($scope.startIndex=0,$scope.endIndex=$scope.startIndex+$scope.pageSize)),$scope.paginated_formatted_rows=$scope.formatted_rows.slice($scope.startIndex,$scope.endIndex),$scope.paginated_rows=$scope.rows.slice($scope.startIndex,$scope.endIndex),$scope.page<=1?$scope.page=1:$scope.page+=-1,scrollTop()},$("body").keydown(function(e){if(!$(e.target).is("textarea")){var keyCode=e.keyCode;39===keyCode?safeApply($scope,function(){$scope.next(),$("#next").attr("tabindex",-1).focus()}):37===keyCode&&safeApply($scope,function(){$scope.previous(),$("#previous").attr("tabindex",-1).focus()})}}),$scope.queryStatusClass=ConsoleFormatting.queryStatusClass,$scope.urlEncodedJson=function(json){return encodeURIComponent(JSON.stringify(json))},self.setInputScope=function(scope){inputScope=scope},$scope.storeInLocalStorageChanged=function(){localStorage.setItem("crate.console.store_queries",$scope.useLocalStorage===!0?"1":"0")},$scope.showErrorTraceChanged=function(){localStorage.setItem("crate.console.error_trace",$scope.showErrorTrace===!0?"1":"0")},$scope.formatReturnedResults=function(){localStorage.setItem("crate.console.format_results",$scope.formatResults===!0?"1":"0")};var getRecentQueriesFromLocalStorage=function(){var queryList=localStorage.getItem("crate.console.query_list");self.recentQueries=queryList?JSON.parse(queryList):[]},updateRecentQueries=function(stmt){$scope.useLocalStorage&&getRecentQueriesFromLocalStorage(),self.recentQueries[self.recentQueries.length-1]!==stmt&&self.recentQueries.push(stmt+";"),$scope.useLocalStorage&&localStorage.setItem("crate.console.query_list",JSON.stringify(self.recentQueries)),inputScope&&(inputScope.recentCursor=-1)};$scope.hide=function(item){item.hide=!0,item.message=""},$scope.toggleOptions=function(){$scope.showOptions=!$scope.showOptions},$scope.clearLocalStorage=function(){$translate(["CONSOLE.CLEAR_HISTORY_MSG","CONSOLE.CLEAR_HISTORY_MSG_PLURAL"]).then(function(i18n){var history=JSON.parse(localStorage.getItem("crate.console.query_list")||"[]");localStorage.setItem("crate.console.query_list",JSON.stringify([])),inputScope.recentCursor=0,self.recentQueries=[];var msg=history.length?0:history.length+" ";msg+=0===history.length||1===history.length?i18n["CONSOLE.CLEAR_HISTORY_MSG"]:i18n["CONSOLE.CLEAR_HISTORY_MSG_PLURAL"],$scope.info.message=msg,$scope.info.hide=!1})},$scope.ColumnTypeCheck=ColumnTypeCheck;var doStoreQueries=localStorage.getItem("crate.console.store_queries")||"1";$scope.useLocalStorage=!!parseInt(doStoreQueries),getRecentQueriesFromLocalStorage(),self.execute=function(sql){$scope.startIndex=0,$scope.page=1,$scope.numberOfPages=1,$scope.endIndex=$scope.startIndex+$scope.pageSize,$scope.renderTable=!1;var stmt=sql.replace(/^\s+|\s+$/g,"");""!==stmt&&(stmt=stmt.replace(/([^;]);+$/,"$1"),stmt.match(/^\s*select\s/gi)&&!stmt.match(/limit\s+\d+/gi)&&(stmt+=" limit 100"),updateRecentQueries(stmt),$scope.loading=!0,$("#console-options").slideUp(),SQLQuery.execute(stmt,{},$scope.showErrorTrace,!0,!0,!1).success(function(sqlQuery){$scope.loading=!1,$scope.error.hide=!0,$scope.error.message="",$scope.error.error_trace="",$scope.info.hide=!0,$scope.info.message="",$scope.renderTable=!0,$scope.resultHeaders=[];for(var i=0;i<sqlQuery.cols.length;i++)$scope.resultHeaders.push(sqlQuery.cols[i]);for($scope.resultHeaderTypes=[],i=0;i<sqlQuery.col_types.length;i++)$scope.resultHeaderTypes.push(sqlQuery.col_types[i]);$scope.rows=sqlQuery.rows,$scope.limitToAmount=0,$scope.status=sqlQuery.status(),$scope.statement=stmt+";",inputScope.updateInput($scope.statement),formatData(),$scope.paginated_rows=$scope.rows.slice($scope.startIndex,$scope.endIndex),$scope.numberOfPages=Math.ceil($scope.rows.length/$scope.pageSize),ClusterState.refresh()}).error(function(sqlQuery){$scope.loading=!1,$scope.error.hide=!1,$scope.renderTable=!1,$scope.error=sqlQuery.error,$scope.showErrorTrace||displayedErrorTraceHint||(displayedErrorTraceHint=!0,localStorage.setItem("crate.console.displayed_error_trace_hint","1")),$scope.status=sqlQuery.status(),$scope.rows=[],$scope.resultHeaders=[]}))},self.updateStatement=function(stmt){statement=stmt||""},$scope.execute=function(){self.execute(statement),$location.search("query",statement),$("#cr-console-query").attr("tabindex",-1).focus()},$scope.share=function(){statement&&($location.search("query",statement),Clipboard.copy($location.absUrl()))}}]}}).directive("cli",function($timeout,KeywordObjectCreator,$location,ConsoleState,$transitions){return{restrict:"E",transclude:!0,templateUrl:"static/views/editor.html",scope:{mimeType:"@",theme:"@"},require:"^console",link:function($scope,element,attrs,$console){function updateStatementOnUrlSearch(){$location.search().query&&(editor.setValue($location.search().query),$console.updateStatement($location.search().query))}var statement=$location.search().query||"",typedStatement=$location.search().query||"",input=$("textarea",element)[0];CodeMirror.defineMIME("text/x-cratedb",{name:"sql",keywords:KeywordObjectCreator.create(["abs","absolute","action","add","after","alias","all","allocate","alter","always","analyzer","and","any","are","array","array_agg","array_max_cardinality","as","asc","asensitive","assertion","asymmetric","at","atomic","authorization","avg","before","begin","begin_frame","begin_partition","between","bigint","binary","bit","bit_length","blob","boolean","both","breadth","by","byte","call","called","cardinality","cascade","cascaded","case","cast","catalog","catalogs","ceil","ceiling","char","char_filters","char_length","character","character_length","check","clob","close","clustered","coalesce","collate","collation","collect","column","columns","commit","condition","connect","connection","constraint","constraints","constructor","contains","continue","convert","copy","corr","corresponding","count","covar_pop","covar_samp","create","cross","cube","cume_dist","current","current_catalog","current_date","current_path","current_role","current_row","current_schema","current_time","current_timestamp","current_user","cursor","cycle","data","date","day","deallocate","dec","decimal","declare","default","deferrable","deferred","delete","deny","dense_rank","depth","deref","desc","describe","descriptor","deterministic","diagnostics","directory","disconnect","distinct","distributed","do","domain","double","drop","duplicate","dynamic","each","element","else","elseif","end","end_exec","end_frame","end_partition","equals","escape","every","except","exception","exec","execute","exists","exit","explain","extends","external","extract","false","fetch","filter","first","first_value","float","for","foreign","format","found","frame_row","free","from","full","fulltext","function","functions","fusion","general","generated","geo_point","geo_shape","get","global","go","goto","grant","group","grouping","groups","handler","having","hold","hour","identity","if","ignored","immediate","in","index","indicator","initially","inner","inout","input","insensitive","insert","int","integer","intersect","intersection","interval","into","ip","is","isolation","iterate","join","key","kill","language","large","last","last_value","lateral","lead","leading","leave","left","level","like","like_regex","limit","ln","local","localtime","localtimestamp","locator","long","loop","lower","map","match","max","member","merge","method","min","minute","mod","modifies","module","month","multiset","names","national","natural","nchar","nclob","new","next","no","none","normalize","not","nth_value","ntile","null","nullif","nulls","numeric","object","octet_length","of","off","offset","old","on","only","open","optimize","option","or","order","ordinality","out","outer","output","over","overlaps","overlay","pad","parameter","partial","partition","partitioned","partitions","path","percent","percent_rank","percentile_cont","percentile_disc","period","persistent","plain","portion","position","position_regex","power","precedes","preceding","precision","prepare","preserve","primary","primary key","prior","privileges","procedure","public","range","rank","read","reads","real","recursive","ref","references","referencing","refresh","regr_avgx","regr_avgy","regr_count","regr_intercept","regr_r2","regr_slope","regr_sxx","regr_sxyregr_syy","relative","release","rename","repeat","repository","reset","resignal","restore","restrict","result","return","returns","revoke","right","role","rollback","rollup","routine","row","row_number","rows","savepoint","schema","schemas","scope","scroll","search","second","section","select","sensitive","session","session_user","set","sets","shards","short","show","signal","similar","size","smallint","snapshot","some","space","specific","specifictype","sql","sqlcode","sqlerror","sqlexception","sqlstate","sqlwarning","sqrt","start","state","static","stddev_pop","stddev_samp","stratify","stratify","strict","string","submultiset","substring","substring_regex","succeedsblob","sum","symmetric","system","system_time","system_user","table","tables","tablesample","temporary","text","then","time","timestamp","timezone_hour","timezone_minute","to","token_filters","tokenizer","trailing","transaction","transient","translate","translate_regex","translation","treat","trigger","trim","trim_array","true","truncate","try_cast","type","uescape","unbounded","under","undo","union","unique","unknown","unnest","until","update","upper","usage","user","using","value","value_of","values","var_pop","var_samp","varbinary","varchar","varying","versioning","view","when","whenever","where","while","width_bucket","window","with","within","without","work","write","year","zone"]),operatorChars:/^[*+\-%<>!=~]/});var editor=CodeMirror.fromTextArea(input,{mode:attrs.mimeType,theme:attrs.theme,lineWrapping:!0,indentWithTabs:!1,indentUnit:2,tabSize:2});if(editor.setOption("extraKeys",{Tab:function(cm){var spaces=" ".repeat(cm.getOption("indentUnit"));cm.replaceSelection(spaces)}}),""===statement&&ConsoleState.restore().stmt){var stmt=ConsoleState.restore().stmt;editor.setValue(stmt),$console.updateStatement(stmt)}updateStatementOnUrlSearch(),$scope.$on("$stateChangeStart",updateStatementOnUrlSearch.bind(this)),editor.on("change",function(instance){statement=instance.getValue(),$console.updateStatement(statement)});var selectStatementInput=function(stmt){stmt&&editor.setValue(stmt),$timeout(function(){editor.execCommand("selectAll")},10)},getRecentQueriesIndex=function(queryCount,recentCursor){return queryCount+recentCursor>0?queryCount+recentCursor:0};editor.on("keydown",function(instance,event){var cursorPos=event.target.selectionStart,queryCount=$console.recentQueries.length,cursor=instance.getCursor(),selection=instance.getSelection();event.shiftKey||38!==event.keyCode?event.shiftKey||40!==event.keyCode?13===event.keyCode&&event.shiftKey?(event.preventDefault(),$console.execute(statement),typedStatement=""):$scope.recentCursor=0:(cursorPos>=event.target.textLength||0===cursorPos&&event.target.selectionEnd===statement.length)&&queryCount+$scope.recentCursor<queryCount&&($scope.recentCursor++,statement=$console.recentQueries[getRecentQueriesIndex(queryCount,$scope.recentCursor)]||typedStatement,selectStatementInput(statement)):(0===cursor.ch&&0===cursor.line||0===cursor.line&&selection===statement)&&(0===$scope.recentCursor&&(typedStatement=statement),$scope.recentCursor--,statement=$console.recentQueries[getRecentQueriesIndex(queryCount,$scope.recentCursor)]||"",selectStatementInput(statement))}),$console.setInputScope($scope),$scope.recentCursor=0,$scope.updateInput=function(stmt){selectStatementInput(stmt)},$transitions.onStart({},function(){var state={};state.stmt=editor.getValue(),ConsoleState.save(state)})}}}).directive("formattedArray",function(ObjectTypeCheck){return{restrict:"E",scope:{array:"=",typesarray:"@",expand:"@"},templateUrl:"static/views/formatted-array-template.html",link:function(scope){scope.isExpanded="true"===scope.expand,scope.typesarray=JSON.parse(scope.typesarray),
scope.ObjectTypeCheck=ObjectTypeCheck,scope.getArrayLength=function(){return scope.array.length},scope.formatArrayindex=function(index){return index+1},scope.getArrayType=function(){return 101==scope.typesarray[0]?"Set":"Array"},scope.toggleExpand=function(){scope.isExpanded=!scope.isExpanded}}}}).directive("formattedObject",function(ObjectTypeCheck){return{restrict:"E",scope:{object:"=",expand:"@"},templateUrl:"static/views/formatted-object-template.html",link:function(scope){scope.isExpanded="true"===scope.expand,scope.ObjectTypeCheck=ObjectTypeCheck,scope.keys=Object.keys(scope.object),scope.getField=function(key){return scope.object[key]},scope.toggleExpand=function(){scope.isExpanded=!scope.isExpanded}}}}).controller("ConsoleController",function(){}),angular.module("tables",["stats","sql","common","tableinfo","events"]).provider("TabNavigationInfo",function(){this.collapsed=[!1,!0],this.$get=function(){var collapsed=this.collapsed;return{collapsed:collapsed,toggleIndex:function(index){collapsed[index]=!collapsed[index]},collapseIndex:function(index){collapsed[index]=!0},unCollapseIndex:function(index){collapsed[index]=!1}}}}).factory("PartitionsTableController",function(){return function(){this.data=[],this.sort={col:"partition_ident",desc:!1},this.setPartitions=function(partitions){this.data=partitions},this.sortByColumn=function(col){this.sort.col===col?this.sort.desc=!this.sort.desc:(this.sort.col=col,this.sort.desc=!1)},this.selected=function(col){return col===this.sort.col?this.sort.desc?"fa fa-chevron-down":"fa fa-chevron-up":""}}}).directive("tables",function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"static/views/tables.html",controllerAs:"TablesController",controller:function(ClusterState,$scope,ClusterEventsHandler){$scope.empty=!0,ClusterState.data.tables.length>0&&($scope.empty=!1),ClusterEventsHandler.register("STATE_REFRESHED","TablesController",function(){ClusterState.data.tables.length>0&&($scope.empty=!1)}),$scope.$on("$destroy",function(){ClusterEventsHandler.remove("STATE_REFRESHED","TablesController")})}}}).directive("tableDetail",function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"static/views/table-detail.html",controllerAs:"TableDetailController",controller:function($scope,$location,$log,$timeout,$state,SQLQuery,queryResultToObjects,roundWithUnitFilter,bytesFilter,TableList,TableInfo,TabNavigationInfo,PartitionsTableController,ClusterEventsHandler,ClusterState){$scope.executeQuery=function(query){$location.search({query:query}),$location.path("/console")};var scopeWatcher=null,activeRequests={},colorMapLabel={good:"",warning:"label-warning",critical:"label-danger","--":""},colorMapCell={good:"cr-cell--success",warning:"cr-cell--warning",critical:"cr-cell--danger","--":""},placeholder={name:"",summary:"",health:"--",health_label_class:"",health_panel_class:"",health_cell_class:"",records_total:0,records_replicated:0,records_underreplicated:0,records_unavailable:0,shards_configured:0,shards_started:0,shards_missing:0,shards_underreplicated:0,replicas_configured:"0",size:0,recovery_percent:0},requestId=function(){return"r-"+(new Date).getTime()+"-"+Math.floor(1e3*Math.random())},cancelRequests=function(){for(var k in activeRequests){var request=activeRequests[k];request.cancel()}activeRequests={}},filterByIdent=function(ident){return function(item){return item.partition_ident===ident}},isNestedColumn=function(column){var re=/([^\s]+)(\[\'([^\s]+)\'])+/i;return column.match(re)},render=function(tableSchema,tableName){function updateTableList(){var tables=ClusterState.data.tables;if(tables.length>0){var current=tables.filter(function(item){return item.name===tableName&&item.table_schema===tableSchema});current=current.length?current[0]:tables[0],$scope.table=current,$scope.table_label=current.name,"blob"==current.table_schema?$scope.table_label="BLOB: "+current.name:"doc"!=current.table_schema&&($scope.table_label=current.table_schema+"."+current.name),$scope.nothingSelected=null===current,$scope.renderSidebar=!0,$scope.table.partitioned&&fetchPartitions();var expectedUrl="/tables/"+current.table_schema+"/"+current.name;$location.$$url!==expectedUrl&&$location.url(expectedUrl)}else $scope.table=placeholder,$scope.table_label=placeholder.name,$scope.nothingSelected=!1,$scope.renderSidebar=!1,$scope.renderSchema=!1,$scope.renderPartitions=!1;$scope.nr_of_tables=tables.length}$scope.ptCtlr=new PartitionsTableController,$scope.nothingSelected=!1,$scope.renderSiderbar=!0,$scope.isParted=!1;var constructQuery=function(rows){var query="SELECT ",filtered_columns=rows.filter(function(row){return!isNestedColumn(row.column_name)}).map(function(row){return'"'+row.column_name+'"'});return query+=filtered_columns.join(","),query+=' FROM "'+tableSchema+'"."'+tableName+'" LIMIT 100;'},update=function(success,partitions,cancelled){cancelled||($scope.ptCtlr.data=partitions,$scope.isParted=!0,$scope.renderPartitions=success,$scope.renderSchema=!0)},fetchPartitions=function(){if(tableName&&tableSchema){var shardStmt='SELECT partition_ident, routing_state, state, relocating_node, "primary", SUM(num_docs), AVG(num_docs), COUNT(*), SUM(size) FROM sys.shards WHERE schema_name = ? AND table_name = ? AND partition_ident != \'\' GROUP BY partition_ident, routing_state, state, relocating_node, "primary"',r1=requestId(),q1=SQLQuery.execute(shardStmt,[tableSchema,tableName],!1,!1,!1,!1).success(function(shardQuery){if("undefined"!=typeof activeRequests[r1]){var tablePartitionStmt="SELECT partition_ident, number_of_shards, number_of_replicas, values FROM information_schema.table_partitions WHERE schema_name = ? AND table_name = ? AND closed = false",r2=requestId(),q2=SQLQuery.execute(tablePartitionStmt,[tableSchema,tableName],!1,!1,!1,!1).success(function(tablePartitionQuery){if("undefined"!=typeof activeRequests[r2]){for(var partitions=[],shardResult=queryResultToObjects(shardQuery,["partition_ident","routing_state","state","relocating_node","primary","sum_docs","avg_docs","count","size"]),partitionResult=queryResultToObjects(tablePartitionQuery,["partition_ident","number_of_shards","number_of_replicas","values"]),idents=shardResult.reduce(function(memo,obj){var ident=obj.partition_ident;return memo.indexOf(ident)===-1&&memo.push(ident),memo},[]),i=0;i<idents.length;i++){var ident=idents[i],shardInfoForPartition=shardResult.filter(filterByIdent(ident)),confInfoForPartition=partitionResult.filter(filterByIdent(ident));if(1===confInfoForPartition.length){var info=new TableInfo(shardInfoForPartition,confInfoForPartition[0].number_of_shards),o=info.asObject();o.partition_values=confInfoForPartition[0].values,o.partition_ident=ident,o.replicas_configured=confInfoForPartition[0].number_of_replicas,o.health_label_class=colorMapLabel[o.health],o.health_cell_class=colorMapCell[o.health],partitions.push(o)}}update(!0,partitions,"undefined"==typeof activeRequests[r2]),delete activeRequests[r2]}}).error(function(){update(!1,[],"undefined"==typeof activeRequests[r2]),delete activeRequests[r2]});delete activeRequests[r1],activeRequests[r2]=q2}}).error(function(){update(!1,[],"undefined"==typeof activeRequests[r1]),delete activeRequests[r1]});activeRequests[r1]=q1}};if(tableName&&tableSchema){var tableStmt="SELECT column_name, data_type, is_generated, generation_expression FROM information_schema.columns WHERE table_schema = ? AND table_name = ?";SQLQuery.execute(tableStmt,[tableSchema,tableName],!1,!1,!1,!1).success(function(query){$scope.schemaHeaders=query.cols,$scope.schemaRows=queryResultToObjects(query,query.cols),$scope.renderSchema=!0,$scope.query=constructQuery($scope.schemaRows)}).error(function(){$scope.renderSchema=!1})}ClusterEventsHandler.register("STATE_REFRESHED","TableDetailController",updateTableList),updateTableList(),$scope.$on("$destroy",function(){cancelRequests(),scopeWatcher&&(scopeWatcher(),scopeWatcher=null),ClusterEventsHandler.remove("STATE_REFRESHED","TableDetailController")}),$scope.table=null,$scope.renderSidebar=!0,$scope.renderSchema=!1,$scope.renderPartitions=!1,updateTableList()};$("[rel=tooltip]").tooltip({placement:"top"}),$scope.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")},render($state.params.table_schema,$state.params.table_name)}}}).directive("tableList",function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"static/views/tablelist.html",controllerAs:"TableListController",controller:function($scope,$state,TabNavigationInfo,ClusterEventsHandler,ClusterState){function updateTableList(){$scope.tables=[];var tables=ClusterState.data.tables,hasTables=tables.length>0;if($scope.renderSidebar=hasTables,hasTables){$scope.tableName&&$scope.tableSchema||($scope.tableName=tables[0].name,$scope.tableSchema=tables[0].table_schema,$state.go("tables.table",{table_schema:$scope.tableSchema,table_name:$scope.tableName}));var idx,name,customSchemas=[];for(idx in tables)name=tables[idx].table_schema,"doc"==name||"blob"==name||customSchemas.indexOf(name)>-1||customSchemas.push(name);$scope.tables.push({display_name:"Doc",tables:tables.filter(function(item){return"doc"==item.table_schema}),table_schema:"doc"});for(idx in customSchemas)name=customSchemas[idx],$scope.tables.push({display_name:name,tables:tables.filter(filterBySchemaName(name)),table_schema:name});$scope.tables.push({display_name:"Blob",tables:tables.filter(function(item){return"blob"==item.table_schema}),table_schema:"blob"})}}var filterBySchemaName=function(name){return function(item){return item.table_schema==name}};$scope.collapsed=!0,$scope.table_filter=function(item){return!$scope.query||item.fqn.toLowerCase().indexOf($scope.query)!=-1},ClusterEventsHandler.register("STATE_REFRESHED","TableListController",updateTableList),updateTableList();var render=function(tableSchema,tableName){$scope.tableName=tableName,$scope.tableSchema=tableSchema,$scope.renderSidebar=!0,updateTableList(),$scope.isActive=function(table_schema,table_name){return table_name===$state.params.table_name&&table_schema===$state.params.table_schema},$scope.startedShardsError=function(table){return(!table.partitioned||0!==table.shards_started)&&table.shards_started<table.shards_configured},$scope.toggleElements=function(index){$("#nav-tabs-"+index).collapse("toggle"),$("#nav-tabs-header-"+index+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),TabNavigationInfo.toggleIndex(index)},$scope.isCollapsed=function(index){return TabNavigationInfo.collapsed[index]};var table;$scope.collapseAll=function(){for(table in $scope.tables)$("#nav-tabs-"+table).collapse("toggle"),$("#nav-tabs-header-"+table+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),TabNavigationInfo.collapseIndex(table);$scope.collapsed=!0},$scope.unCollapseAll=function(){for(table in $scope.tables)$("#nav-tabs-"+table).collapse("toggle"),$("#nav-tabs-header-"+table+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),TabNavigationInfo.unCollapseIndex(table);$scope.collapsed=!1}};$scope.$on("$destroy",function(){ClusterEventsHandler.remove("STATE_REFRESHED","TableListController")}),render($state.params.table_schema,$state.params.table_name)}}}),angular.module("cluster",["stats","sql","common","nodeinfo","events"]).directive("cluster",function(){return{restrict:"E",replace:!0,scope:{},templateUrl:"static/views/node.html",controllerAs:"ClusterController",controller:function($scope,$state,ClusterState,prepareNodeList,compareByHealth,ClusterEventsHandler){function redirectToFirstNode(){!firstRedirect&&$scope.selectedNode&&$scope.selectedNode.id&&(firstRedirect=!0,$state.go("nodes.node",{node_id:$scope.selectedNode.id}))}$scope.nodes=[],$scope.selectedNode=null,$scope.version=null,$scope.nodeId=$state.params.node_id;var firstRedirect=!1,getUpdatedNodeList=function(nodeId){var cluster=ClusterState.data.cluster;if($scope.version=ClusterState.data.version,$scope.nodes=prepareNodeList(cluster,ClusterState.data.master_node),$scope.renderSidebar=cluster.length>0,$scope.renderSidebar){$scope.nodes=$scope.nodes.sort(compareByHealth);var nodeIds=$scope.nodes.map(function(obj){return obj.id});if($scope.nodeId&&nodeIds.indexOf(nodeId)>=0){var selectedNode=$scope.nodes.filter(function(node){return node.id===nodeId});$scope.selectedNode=selectedNode.length?selectedNode[0]:$scope.nodes[0]}else $scope.selectedNode=$scope.nodes[0],nodeId=$scope.nodes[0].id}else $scope.selectedNode=null};getUpdatedNodeList($scope.nodeId),redirectToFirstNode(),ClusterEventsHandler.register("STATE_REFRESHED","ClusterController",function(){getUpdatedNodeList($scope.nodeId),redirectToFirstNode()}),$scope.$on("$destroy",function(){ClusterEventsHandler.remove("STATE_REFRESHED","ClusterController")})}}}).directive("nodeList",function(){return{restrict:"E",replace:!0,scope:{nodes:"=",selected:"="},templateUrl:"static/views/nodelist.html",controllerAs:"NodeListController",controller:function($scope,$state,NodeListInfo,compareByHealth,HealthPanelClass){$scope.goToPath=function(id){$state.go("nodes.node",{node_id:id})},$scope.healthPanelClass=HealthPanelClass,$scope.sort=NodeListInfo.sort,$scope.sortBy=NodeListInfo.sortBy,$scope.sortClass=NodeListInfo.sortClass,$scope.isActive=function(node){return node.id===$state.params.node_id},$scope.isSameVersion=function(nodeVersion){return!$scope.version||nodeVersion.build_hash===$scope.version.hash},$scope.$watch("nodes",function(){$scope.renderSidebar=$scope.nodes.length>0})}}}).directive("nodeDetail",function(){return{restrict:"E",replace:!0,require:"^ClusterController",scope:{},templateUrl:"static/views/node-detail.html",controllerAs:"NodeDetailController",controller:function($scope,$interval,$state,$http,$filter,$location,ClusterState,prepareNodeList,compareByHealth,ClusterEventsHandler){var byteFormatFunction=$filter("bytes");$scope.node=null;var options={chart:{type:"multiBarHorizontalChart",height:20,margin:{left:0,top:0,bottom:0,right:0},forceY:[0,100],showControls:!1,showValues:!1,duration:500,showLegend:!1,stacked:!0,showXaxis:!1,showYaxis:!1,x:function(d){return d.label},y:function(d){return d.value},xAxis:{showMaxMin:!1},yAxis:{}}};$scope.percent_options=angular.copy(options),$scope.percent_options.chart.yAxis={tickFormat:function(d){return String(d)+"%"}},$scope.bytes_options=angular.copy(options),$scope.bytes_options.chart.yAxis={tickFormat:function(d){return byteFormatFunction(d,2)}};var empty={name:"",id:"",summary:[],health:"--",health_label_class:"",health_panel_class:"",hostname:"--",address:"",version:{number:"--",build_hash:"",build_snapshot:!1},heap:{total:0,free:0,used:0,used_percent:0,free_percent:0},fs:{total:0,available:0,used:0,available_percent:0,used_percent:0},shardInfo:{started:-1,initializing:-1,reallocating:-1,postrecovery:-1}},COLORS={used:"#5bd5f5",free:"#e2e2e2"},version=null,aggregateDataDiskUtilisation=function(node){var fs={total:0,available:0,used:0,available_percent:0,used_percent:0};if(node.fs&&node.fs.data){for(var dataDisks=[],k=0;k<node.fs.data.length;k++)dataDisks.push(node.fs.data[k].dev);for(var j=0;j<node.fs.disks.length;j++){var disk=node.fs.disks[j],isDataDisk=dataDisks.indexOf(disk.dev)>-1;isDataDisk&&(fs.total+=disk.size,fs.available+=disk.available,fs.used+=disk.used)}fs.available_percent=100*fs.available/fs.total,fs.used_percent=100*fs.used/fs.total}return fs},getShardsCountPerState=function(shardInfo,state){return shardInfo.filter(function(shard){return shard.state===state}).reduce(function(acc,table){return acc+table.count},0)},drawGraph=function(node){$scope.cpuData=[{key:"Used",values:[{label:"CPU",value:node.cpu?node.cpu.used:0}],color:COLORS.used},{key:"Free",values:[{label:"CPU",value:node.cpu?100-node.cpu.used:100}],color:COLORS.free}],$scope.heapData=[{key:"Used",values:[{label:"HEAP",value:node.heap?node.heap.used:0}],color:COLORS.used},{key:"Free",values:[{label:"HEAP",value:node.heap?node.heap.max-node.heap.used:100}],color:COLORS.free}],$scope.diskUsageData=[{key:"Used",values:[{label:"Disk Usage",value:node.fs?node.fs.used:0}],color:COLORS.used},{key:"Free",values:[{label:"Disk Usage",value:node.fs?node.fs.available:100}],color:COLORS.free}],$scope.processCpuData=[{key:"Used",values:[{label:"Process CPU",value:node.proc_cpu?Math.min(100,node.proc_cpu.percent/node.num_cores):0}],color:COLORS.used},{key:"Idle",values:[{label:"Process CPU",value:node.proc_cpu?100-Math.min(100,node.proc_cpu.percent/node.num_cores):100}],color:COLORS.free}]},updateNodeList=function(nodeId){for(var cluster=angular.copy(ClusterState.data.cluster),shards=angular.copy(ClusterState.data.shards),i=0;i<cluster.length;i++)cluster[i].fs=aggregateDataDiskUtilisation(cluster[i]);version=ClusterState.data.version,$scope.renderSidebar=$scope.$parent.renderSidebar;var nodeList=prepareNodeList(cluster,ClusterState.data.master_node);if($scope.renderSidebar){nodeList=nodeList.sort(compareByHealth);var currentNode,nodeIds=nodeList.map(function(obj){return obj.id});if(nodeId&&nodeIds.indexOf(nodeId)>=0){var selectedNode=nodeList.filter(function(node){return node.id==nodeId});currentNode=selectedNode.length?selectedNode[0]:nodeList[0]}else currentNode=nodeList[0];$scope.node=currentNode,drawGraph($scope.node)}else $scope.node=angular.copy(empty);if($scope.node&&shards&&shards.length){var shardInfoPerNode=shards.filter(function(shard){return shard.node_id===$scope.node.id});$scope.shardInfo={started:getShardsCountPerState(shardInfoPerNode,"STARTED"),initializing:getShardsCountPerState(shardInfoPerNode,"INITIALIZING"),reallocating:getShardsCountPerState(shardInfoPerNode,"REALLOCATING"),postrecovery:getShardsCountPerState(shardInfoPerNode,"POST_RECOVERY")}}},render=function(nodeId){updateNodeList(nodeId)};ClusterEventsHandler.register("STATE_REFRESHED","NodeDetailController",function(){updateNodeList($state.params.node_id)}),$scope.$on("$destroy",function(){ClusterEventsHandler.remove("STATE_REFRESHED","NodeDetailController")}),$scope.toolTipUsedPercentFunction=function(){return function(key,x,y){return"<p>"+key+"<br /><b>"+y+"%</b></p>"}},$scope.toolTipUsedBytesFunction=function(){return function(key,x,y){return"<p>"+key+"<br /><b>"+y+"</b></p>"}},$scope.yAxisByteFormatFunction=function(){return function(d){return byteFormatFunction(d,2)}},$("[rel=tooltip]").tooltip({placement:"top"}),$scope.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")},$scope.isSameVersion=function(nodeVersion){return!version||nodeVersion.build_hash===version.hash},render($state.params.node_id)}}}),angular.module("common").filter("capitalize",function(){return function(input){return input.substring(0,1).toUpperCase()+input.substring(1)}}).service("SeverityClass",function(){return function(severity){switch(severity){case 1:return"severity--info";case 2:return"severity--warning";case 3:return"severity--danger";default:return"severity--info"}}}).filter("severityText",function($filter){return function(severity){var translate=$filter("translate");switch(severity){case 1:return translate("OVERVIEW.INFO");case 2:return translate("OVERVIEW.WARNING");case 3:return translate("OVERVIEW.CRITICAL");default:return translate("OVERVIEW.INF")}}}).service("HealthPanelClass",function(){return function(health){switch(health){case"good":return"cr-panel--success";case"warning":return"cr-panel--warning";case"danger":return"cr-panel--danger";case"critical":return"cr-panel--danger";case"--":return"cr-panel--default";case"unreacheable":return"cr-panel--unreacheable";default:return"cr-panel--default"}}}).filter("languageFilter",function(){return function(langkey){switch(langkey){case"en":return"English";case"de":return"Deutsch";case"es":return"Español";default:return"Auto"}}}).filter("formatTimestamp",function(){return function(timestamp){return new Date(timestamp).toISOString()}}),angular.module("common").filter("floor",function($filter){var f=$filter("number");return function(value,fraction){var n=Math.pow(10,fraction);return f(Math.floor(value*n)/n,fraction)}}).filter("roundWithUnit",function($filter,$sce){var f=$filter("number");return function(input,fraction){var res="";return"undefined"==typeof fraction&&(fraction=3),res=Math.abs(Number(input))>=1e9?f(Math.abs(Number(input))/1e9,fraction)+" Billion":Math.abs(Number(input))>=1e6?f(Math.abs(Number(input))/1e6,fraction)+" Million":f(Math.abs(Number(input)),0),$sce.trustAsHtml(res)}}).filter("bytes",function($sce){var units=["B","KB","MB","GB","TB","PB"];return function(bytes,precision){if(isNaN(parseFloat(bytes))||!isFinite(bytes))return"-";if(0===bytes)return"0 B";"undefined"==typeof precision&&(precision=1);var number=Math.floor(Math.log(bytes)/Math.log(1024)),res=(bytes/Math.pow(1024,Math.floor(number))).toFixed(precision)+" "+units[number];return $sce.trustAsHtml(res)}});